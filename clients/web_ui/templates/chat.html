<div class="flex flex-col h-full">
    <!-- Chat Header -->
    <div class="border-b border-base-300 p-4">
        <div class="flex items-center justify-between">
            <input type="text" 
                   name="title" 
                   value="{{ current_session.title }}"
                   class="input input-ghost text-lg font-semibold w-full max-w-md"
                   hx-patch="/sessions/{{ current_session.id }}"
                   hx-trigger="change"
                   hx-swap="none">
            <div class="flex items-center gap-2">
                <div id="token-usage-{{ current_session.id }}">
                    {% include "token_usage.html" %}
                </div>
                <button class="btn btn-ghost btn-sm btn-error"
                        hx-delete="/sessions/{{ current_session.id }}"
                        hx-swap="none"
                        onclick="return confirm('Delete this session?')">
                    Delete
                </button>
            </div>
        </div>
    </div>
    
    <!-- Messages -->
    <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4">
        {% for message in current_session.messages %}
            {% include "message.html" %}
        {% endfor %}
        
        {% if current_session.status.value == 'running' %}
        <div class="alert alert-warning">
            <span>Connection lost. Agent is running, check again later.</span>
        </div>
        {% endif %}
    </div>
    
    <!-- Input Form -->
    <div class="border-t border-base-300 p-4">
        <form id="chat-form"
              hx-post="/sessions/{{ current_session.id }}/stream"
              hx-swap="beforeend"
              hx-target="#messages">
            <div class="flex gap-2">
                <input type="text" 
                       name="query" 
                       class="input input-bordered flex-1" 
                       placeholder="Ask something..."
                       required
                       autocomplete="off">
                <button type="submit" class="btn btn-primary" id="send-btn">
                    Send
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('chat-form');
    const messagesDiv = document.getElementById('messages');
    const sendBtn = document.getElementById('send-btn');
    const queryInput = form.querySelector('input[name="query"]');
    
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        const query = formData.get('query');
        
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<span class="loading loading-spinner"></span>';
        queryInput.disabled = true;
        
        try {
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                throw new Error('Request failed');
            }
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let currentData = '';
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) {
                    if (currentData.trim()) {
                        appendHtml(currentData);
                    }
                    break;
                }
                
                buffer += decoder.decode(value, { stream: true });
                
                // Process complete SSE messages (separated by blank lines)
                while (buffer.includes('\n\n')) {
                    const messageEnd = buffer.indexOf('\n\n');
                    const message = buffer.slice(0, messageEnd);
                    buffer = buffer.slice(messageEnd + 2);
                    
                    // Extract data from the message
                    const dataLines = [];
                    for (const line of message.split('\n')) {
                        if (line.startsWith('data:')) {
                            let data = line.slice(5);
                            // Remove leading space if present (SSE continuation)
                            if (data.startsWith(' ')) {
                                data = data.slice(1);
                            }
                            dataLines.push(data);
                        }
                    }
                    
                    if (dataLines.length > 0) {
                        const html = dataLines.join('\n');
                        appendHtml(html);
                    }
                }
            }
            
            // Handle any remaining data in buffer
            if (buffer.trim()) {
                const dataLines = [];
                for (const line of buffer.split('\n')) {
                    if (line.startsWith('data:')) {
                        let data = line.slice(5);
                        if (data.startsWith(' ')) {
                            data = data.slice(1);
                        }
                        dataLines.push(data);
                    }
                }
                if (dataLines.length > 0) {
                    appendHtml(dataLines.join('\n'));
                }
            }
            
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            form.reset();
        } catch (err) {
            console.error('SSE error:', err);
            messagesDiv.innerHTML += `<div class="alert alert-error"><span>Error: ${err.message}</span></div>`;
        } finally {
            sendBtn.disabled = false;
            sendBtn.innerHTML = 'Send';
            queryInput.disabled = false;
            queryInput.focus();
        }
    });
    
    function appendHtml(html) {
        if (!html || !html.trim()) return;
        const temp = document.createElement('div');
        temp.innerHTML = html;
        while (temp.firstChild) {
            messagesDiv.appendChild(temp.firstChild);
        }
    }
});
</script>
